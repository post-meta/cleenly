# CLEENLY — Authentication, Dashboard & Payments Implementation

**Проект:** CLEENLY (cleenly.app)  
**Цель:** Реализовать систему входа, личный кабинет и платёжную систему  
**Принципы:** Lazy auth, Guest checkout, Честность в платежах

---

## ОБЩАЯ СТРАТЕГИЯ

### Authentication Philosophy: "Lazy Authentication"

- Guest checkout — первый букинг БЕЗ регистрации
- Auto-account creation — аккаунт создаётся автоматически после первого букинга
- Optional login — если хочешь управлять букингами, заходи позже
- Multiple auth methods — Magic Link (primary), Google, SMS, Telegram

### Payment Philosophy: "Честность + Гибкость"

- Прозрачность — когда и как платить всегда понятно
- Множество способов — Card, Cash, Check, (Venmo/CashApp позже)
- No hidden fees — всё включено в цену
- Trust-based — защита обеих сторон

---

## TECH STACK

### Core
- Next.js 15 (App Router)
- TypeScript (strict mode)
- Tailwind CSS 4
- Supabase (PostgreSQL + Auth)

### Authentication
- NextAuth.js v5 (Auth.js)
- Providers: Email (Resend), Google OAuth, SMS (Twilio), Telegram
- Session: JWT (stateless)

### Payments
- Stripe (Payment Intents + Setup Intents)
- Webhook handling for async events
- Card holds for cash/check payments

### Communication
- Resend (transactional emails)
- Twilio (SMS notifications + OTP)
- Push notifications (optional, later)

---

# PART 1: AUTHENTICATION

## TASK 1: Setup NextAuth.js + Supabase Integration

**Цель:** Настроить базовую инфраструктуру для auth.

**Что сделать:**

1. **Install dependencies:**
```bash
npm install next-auth@beta @auth/core @supabase/supabase-js
npm install @auth/supabase-adapter
```

2. **Create auth config:**

**File:** `auth.config.ts`
```typescript
import type { NextAuthConfig } from 'next-auth';

export const authConfig = {
  pages: {
    signIn: '/login',
    signOut: '/logout',
    error: '/auth/error',
    verifyRequest: '/auth/verify-request',
  },
  callbacks: {
    authorized({ auth, request: { nextUrl } }) {
      const isLoggedIn = !!auth?.user;
      const isOnDashboard = nextUrl.pathname.startsWith('/dashboard');
      
      if (isOnDashboard) {
        if (isLoggedIn) return true;
        return false; // Redirect to login
      }
      
      return true;
    },
  },
  providers: [], // Add providers in auth.ts
} satisfies NextAuthConfig;
```

**File:** `auth.ts`
```typescript
import NextAuth from 'next-auth';
import { authConfig } from './auth.config';
import { SupabaseAdapter } from '@auth/supabase-adapter';

export const { handlers, auth, signIn, signOut } = NextAuth({
  ...authConfig,
  adapter: SupabaseAdapter({
    url: process.env.SUPABASE_URL!,
    secret: process.env.SUPABASE_SERVICE_ROLE_KEY!,
  }),
  session: { strategy: 'jwt' },
  providers: [
    // Will add in next tasks
  ],
});
```

**File:** `app/api/auth/[...nextauth]/route.ts`
```typescript
import { handlers } from '@/auth';
export const { GET, POST } = handlers;
```

3. **Environment variables:**
```env
# Supabase
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=generate_with_openssl_rand_base64_32
```

4. **Middleware for protected routes:**

**File:** `middleware.ts`
```typescript
import { auth } from '@/auth';
import { NextResponse } from 'next/server';

export default auth((req) => {
  const { nextUrl } = req;
  const isLoggedIn = !!req.auth;

  const isProtectedRoute = nextUrl.pathname.startsWith('/dashboard');

  if (isProtectedRoute && !isLoggedIn) {
    return NextResponse.redirect(new URL('/login', nextUrl));
  }

  return NextResponse.next();
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

**Acceptance Criteria:**
- [ ] NextAuth.js установлен и настроен
- [ ] Supabase adapter подключен
- [ ] Middleware защищает /dashboard routes
- [ ] Env variables настроены
- [ ] No TypeScript errors

---

## TASK 2: Magic Link (Email) Provider

**Цель:** Реализовать вход по email через magic link.

**Что сделать:**

1. **Install Resend:**
```bash
npm install resend
```

2. **Setup Resend provider:**

**File:** `lib/email.ts`
```typescript
import { Resend } from 'resend';

export const resend = new Resend(process.env.RESEND_API_KEY);

export async function sendMagicLinkEmail({
  email,
  url,
}: {
  email: string;
  url: string;
}) {
  await resend.emails.send({
    from: 'CLEENLY <noreply@cleenly.app>',
    to: email,
    subject: 'Sign in to CLEENLY',
    html: `
      <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
        <h1 style="font-size: 24px; font-weight: 600; margin-bottom: 24px;">
          Sign in to CLEENLY
        </h1>
        <p style="font-size: 16px; color: #525252; margin-bottom: 24px;">
          Click the button below to sign in to your account:
        </p>
        <a 
          href="${url}" 
          style="
            display: inline-block;
            background: #D97757;
            color: white;
            padding: 12px 32px;
            text-decoration: none;
            border-radius: 2px;
            font-weight: 500;
          "
        >
          Sign In
        </a>
        <p style="font-size: 14px; color: #737373; margin-top: 24px;">
          This link expires in 24 hours. If you didn't request this, ignore this email.
        </p>
      </div>
    `,
  });
}
```

3. **Add Email provider to auth.ts:**
```typescript
import Email from 'next-auth/providers/email';
import { sendMagicLinkEmail } from '@/lib/email';

providers: [
  Email({
    server: '', // Not needed with custom sendVerificationRequest
    from: 'noreply@cleenly.app',
    sendVerificationRequest: async ({ identifier: email, url }) => {
      await sendMagicLinkEmail({ email, url });
    },
  }),
]
```

4. **Create login page:**

**File:** `app/login/page.tsx`
```typescript
'use client';

import { useState } from 'react';
import { signIn } from 'next-auth/react';
import { Button } from '@/components/ui/button';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);
  const [emailSent, setEmailSent] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      await signIn('email', { email, redirect: false });
      setEmailSent(true);
    } catch (error) {
      console.error('Error signing in:', error);
    } finally {
      setLoading(false);
    }
  };

  if (emailSent) {
    return (
      <div className="min-h-screen flex items-center justify-center px-6">
        <div className="max-w-md w-full space-y-6 text-center">
          <h1 className="text-3xl font-semibold">Check your email</h1>
          <p className="text-gray-600">
            We sent a sign-in link to <strong>{email}</strong>
          </p>
          <p className="text-sm text-gray-600">
            Click the link in the email to sign in. The link expires in 24 hours.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center px-6">
      <div className="max-w-md w-full space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-semibold">Sign in to CLEENLY</h1>
          <p className="text-gray-600 mt-2">
            Enter your email to receive a sign-in link
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">
              Email
            </label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full border border-gray-300 px-4 py-3 rounded-sm"
              placeholder="you@example.com"
            />
          </div>

          <Button
            type="submit"
            variant="primary"
            size="lg"
            disabled={loading}
            className="w-full"
          >
            {loading ? 'Sending...' : 'Send Sign-In Link'}
          </Button>
        </form>

        <div className="text-center">
          <p className="text-sm text-gray-600">
            Or sign in with
          </p>
        </div>

        {/* Other providers will be added here */}
      </div>
    </div>
  );
}
```

5. **Environment variables:**
```env
RESEND_API_KEY=your_resend_api_key
```

**Acceptance Criteria:**
- [ ] Magic link email отправляется
- [ ] Email template выглядит чисто (в стиле CLEENLY)
- [ ] Link работает и логинит пользователя
- [ ] После логина редирект на /dashboard
- [ ] Error handling работает

---

## TASK 3: Google OAuth Provider

**Цель:** Добавить вход через Google.

**Что сделать:**

1. **Setup Google OAuth:**
- Зайди в Google Cloud Console
- Создай OAuth 2.0 credentials
- Authorized redirect URIs: `http://localhost:3000/api/auth/callback/google`
- Скопируй Client ID и Client Secret

2. **Add Google provider:**

**File:** `auth.ts`
```typescript
import Google from 'next-auth/providers/google';

providers: [
  Email({...}), // existing
  Google({
    clientId: process.env.GOOGLE_CLIENT_ID!,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
  }),
]
```

3. **Add Google button to login page:**

**File:** `app/login/page.tsx`
```typescript
import { FcGoogle } from 'react-icons/fc'; // or use lucide-react

// Add after email form:
<div className="relative">
  <div className="absolute inset-0 flex items-center">
    <div className="w-full border-t border-gray-200" />
  </div>
  <div className="relative flex justify-center text-sm">
    <span className="px-2 bg-white text-gray-600">Or continue with</span>
  </div>
</div>

<Button
  variant="secondary"
  size="lg"
  className="w-full"
  onClick={() => signIn('google', { callbackUrl: '/dashboard' })}
>
  <FcGoogle className="w-5 h-5 mr-2" />
  Continue with Google
</Button>
```

4. **Environment variables:**
```env
GOOGLE_CLIENT_ID=your_client_id
GOOGLE_CLIENT_SECRET=your_client_secret
```

**Acceptance Criteria:**
- [ ] Google OAuth работает
- [ ] После авторизации создаётся user в Supabase
- [ ] Редирект на /dashboard
- [ ] Email и name сохраняются из Google profile
- [ ] Button styled правильно

---

## TASK 4: SMS OTP Provider (Twilio)

**Цель:** Добавить вход по SMS с кодом.

**Что сделать:**

1. **Install Twilio:**
```bash
npm install twilio
```

2. **Setup Twilio service:**

**File:** `lib/sms.ts`
```typescript
import twilio from 'twilio';

const client = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

export async function sendOTP(phone: string, code: string) {
  await client.messages.create({
    body: `Your CLEENLY verification code is: ${code}. Valid for 10 minutes.`,
    from: process.env.TWILIO_PHONE_NUMBER,
    to: phone,
  });
}

export function generateOTP(): string {
  return Math.floor(100000 + Math.random() * 900000).toString();
}
```

3. **Create OTP storage (Supabase table):**

```sql
CREATE TABLE otp_codes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  phone TEXT NOT NULL,
  code TEXT NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index for quick lookup
CREATE INDEX idx_otp_phone_code ON otp_codes(phone, code) WHERE NOT used;

-- Auto-delete expired codes
CREATE OR REPLACE FUNCTION delete_expired_otps()
RETURNS void AS $$
BEGIN
  DELETE FROM otp_codes WHERE expires_at < NOW();
END;
$$ LANGUAGE plpgsql;

-- Run every hour
SELECT cron.schedule('delete-expired-otps', '0 * * * *', 'SELECT delete_expired_otps()');
```

4. **Add Credentials provider for SMS:**

**File:** `auth.ts`
```typescript
import Credentials from 'next-auth/providers/credentials';
import { supabase } from '@/lib/supabase';

providers: [
  // ... existing providers
  Credentials({
    id: 'sms',
    name: 'SMS',
    credentials: {
      phone: { label: 'Phone', type: 'text' },
      code: { label: 'Code', type: 'text' },
    },
    async authorize(credentials) {
      if (!credentials?.phone || !credentials?.code) return null;

      // Verify OTP
      const { data: otpRecord } = await supabase
        .from('otp_codes')
        .select('*')
        .eq('phone', credentials.phone)
        .eq('code', credentials.code)
        .eq('used', false)
        .gt('expires_at', new Date().toISOString())
        .single();

      if (!otpRecord) return null;

      // Mark OTP as used
      await supabase
        .from('otp_codes')
        .update({ used: true })
        .eq('id', otpRecord.id);

      // Find or create user
      let { data: user } = await supabase
        .from('users')
        .select('*')
        .eq('phone', credentials.phone)
        .single();

      if (!user) {
        const { data: newUser } = await supabase
          .from('users')
          .insert({ phone: credentials.phone })
          .select()
          .single();
        user = newUser;
      }

      return {
        id: user.id,
        phone: user.phone,
        email: user.email,
        name: user.name,
      };
    },
  }),
]
```

5. **Create API route to send OTP:**

**File:** `app/api/auth/send-otp/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase';
import { sendOTP, generateOTP } from '@/lib/sms';

export async function POST(req: NextRequest) {
  try {
    const { phone } = await req.json();

    if (!phone || !/^\+1\d{10}$/.test(phone)) {
      return NextResponse.json(
        { error: 'Invalid phone number. Use format: +1XXXXXXXXXX' },
        { status: 400 }
      );
    }

    const code = generateOTP();
    const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes

    // Store OTP
    await supabase.from('otp_codes').insert({
      phone,
      code,
      expires_at: expiresAt.toISOString(),
    });

    // Send SMS
    await sendOTP(phone, code);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error sending OTP:', error);
    return NextResponse.json(
      { error: 'Failed to send OTP' },
      { status: 500 }
    );
  }
}
```

6. **Add SMS login UI:**

**File:** `app/login/sms/page.tsx`
```typescript
'use client';

import { useState } from 'react';
import { signIn } from 'next-auth/react';
import { Button } from '@/components/ui/button';

export default function SMSLoginPage() {
  const [step, setStep] = useState<'phone' | 'code'>('phone');
  const [phone, setPhone] = useState('');
  const [code, setCode] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSendOTP = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const res = await fetch('/api/auth/send-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone }),
      });

      if (res.ok) {
        setStep('code');
      } else {
        alert('Failed to send code');
      }
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleVerifyCode = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const result = await signIn('sms', {
        phone,
        code,
        redirect: true,
        callbackUrl: '/dashboard',
      });

      if (result?.error) {
        alert('Invalid code');
      }
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setLoading(false);
    }
  };

  if (step === 'code') {
    return (
      <div className="min-h-screen flex items-center justify-center px-6">
        <div className="max-w-md w-full space-y-6">
          <div className="text-center">
            <h1 className="text-3xl font-semibold">Enter verification code</h1>
            <p className="text-gray-600 mt-2">
              We sent a 6-digit code to {phone}
            </p>
          </div>

          <form onSubmit={handleVerifyCode} className="space-y-4">
            <div>
              <input
                type="text"
                value={code}
                onChange={(e) => setCode(e.target.value)}
                maxLength={6}
                required
                className="w-full border border-gray-300 px-4 py-3 rounded-sm text-center text-2xl tracking-widest"
                placeholder="000000"
              />
            </div>

            <Button
              type="submit"
              variant="primary"
              size="lg"
              disabled={loading || code.length !== 6}
              className="w-full"
            >
              {loading ? 'Verifying...' : 'Verify Code'}
            </Button>

            <Button
              type="button"
              variant="link"
              className="w-full"
              onClick={() => setStep('phone')}
            >
              ← Back
            </Button>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center px-6">
      <div className="max-w-md w-full space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-semibold">Sign in with phone</h1>
          <p className="text-gray-600 mt-2">
            We'll send you a verification code
          </p>
        </div>

        <form onSubmit={handleSendOTP} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">
              Phone Number
            </label>
            <input
              type="tel"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              required
              className="w-full border border-gray-300 px-4 py-3 rounded-sm"
              placeholder="+1 (555) 123-4567"
            />
            <p className="text-xs text-gray-600 mt-1">
              Format: +1XXXXXXXXXX
            </p>
          </div>

          <Button
            type="submit"
            variant="primary"
            size="lg"
            disabled={loading}
            className="w-full"
          >
            {loading ? 'Sending...' : 'Send Code'}
          </Button>
        </form>
      </div>
    </div>
  );
}
```

7. **Environment variables:**
```env
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=your_twilio_number
```

**Acceptance Criteria:**
- [ ] SMS отправляется с кодом
- [ ] Код валидируется и работает
- [ ] Expired коды не работают
- [ ] User создаётся/находится по phone
- [ ] Phone форматирование работает
- [ ] Rate limiting (optional для MVP)

---

## TASK 5: Telegram Login Widget

**Цель:** Добавить вход через Telegram.

**Что сделать:**

1. **Setup Telegram Bot:**
- Создай бота через @BotFather
- Получи bot token
- Настрой domain в bot settings: `/setdomain cleenly.app`

2. **Add Telegram provider:**

**File:** `auth.ts`
```typescript
import Credentials from 'next-auth/providers/credentials';
import crypto from 'crypto';

providers: [
  // ... existing providers
  Credentials({
    id: 'telegram',
    name: 'Telegram',
    credentials: {
      id: { label: 'ID', type: 'text' },
      first_name: { label: 'First Name', type: 'text' },
      username: { label: 'Username', type: 'text' },
      photo_url: { label: 'Photo URL', type: 'text' },
      auth_date: { label: 'Auth Date', type: 'text' },
      hash: { label: 'Hash', type: 'text' },
    },
    async authorize(credentials) {
      if (!credentials) return null;

      // Verify Telegram data
      const botToken = process.env.TELEGRAM_BOT_TOKEN!;
      const { hash, ...data } = credentials;

      const checkString = Object.keys(data)
        .sort()
        .map((key) => `${key}=${data[key]}`)
        .join('\n');

      const secretKey = crypto
        .createHash('sha256')
        .update(botToken)
        .digest();

      const hmac = crypto
        .createHmac('sha256', secretKey)
        .update(checkString)
        .digest('hex');

      if (hmac !== hash) {
        return null; // Invalid hash
      }

      // Check auth_date (not older than 1 hour)
      const authDate = parseInt(data.auth_date);
      const now = Math.floor(Date.now() / 1000);
      if (now - authDate > 3600) {
        return null; // Expired
      }

      // Find or create user
      let { data: user } = await supabase
        .from('users')
        .select('*')
        .eq('telegram_id', data.id)
        .single();

      if (!user) {
        const { data: newUser } = await supabase
          .from('users')
          .insert({
            telegram_id: data.id,
            name: data.first_name,
            username: data.username,
            profile_photo: data.photo_url,
          })
          .select()
          .single();
        user = newUser;
      }

      return {
        id: user.id,
        name: user.name,
        email: user.email,
        image: user.profile_photo,
      };
    },
  }),
]
```

3. **Add Telegram Widget to login page:**

**File:** `app/login/page.tsx`
```typescript
'use client';

import { useEffect } from 'react';
import { signIn } from 'next-auth/react';

export default function LoginPage() {
  useEffect(() => {
    // Load Telegram Widget script
    const script = document.createElement('script');
    script.src = 'https://telegram.org/js/telegram-widget.js?22';
    script.setAttribute('data-telegram-login', process.env.NEXT_PUBLIC_TELEGRAM_BOT_USERNAME!);
    script.setAttribute('data-size', 'large');
    script.setAttribute('data-radius', '2');
    script.setAttribute('data-request-access', 'write');
    script.async = true;

    // Callback when user logs in
    (window as any).onTelegramAuth = async (user: any) => {
      await signIn('telegram', {
        ...user,
        redirect: true,
        callbackUrl: '/dashboard',
      });
    };

    script.setAttribute('data-onauth', 'onTelegramAuth(user)');

    document.getElementById('telegram-login-container')?.appendChild(script);

    return () => {
      delete (window as any).onTelegramAuth;
    };
  }, []);

  return (
    <div className="min-h-screen flex items-center justify-center px-6">
      <div className="max-w-md w-full space-y-6">
        {/* Email form */}
        {/* Google button */}
        
        {/* Telegram Widget */}
        <div className="flex justify-center">
          <div id="telegram-login-container" />
        </div>

        <p className="text-center text-sm text-gray-600">
          <a href="/login/sms" className="text-accent hover:underline">
            Or sign in with phone number →
          </a>
        </p>
      </div>
    </div>
  );
}
```

4. **Update Supabase users table:**
```sql
ALTER TABLE users ADD COLUMN telegram_id TEXT UNIQUE;
ALTER TABLE users ADD COLUMN username TEXT;
```

5. **Environment variables:**
```env
TELEGRAM_BOT_TOKEN=your_bot_token
NEXT_PUBLIC_TELEGRAM_BOT_USERNAME=your_bot_username
```

**Acceptance Criteria:**
- [ ] Telegram widget рендерится
- [ ] Login через Telegram работает
- [ ] Data verification (hash) работает
- [ ] User создаётся с telegram_id
- [ ] Profile photo сохраняется

---

## TASK 6: Guest Checkout + Auto Account Creation

**Цель:** Позволить забукать без регистрации, создать аккаунт автоматически.

**Что сделать:**

1. **Update bookings table schema:**
```sql
ALTER TABLE bookings 
  ADD COLUMN guest_email TEXT,
  ADD COLUMN guest_phone TEXT,
  ADD COLUMN guest_name TEXT;

-- Allow NULL user_id for guest bookings
ALTER TABLE bookings ALTER COLUMN user_id DROP NOT NULL;
```

2. **Create booking API route (guest-enabled):**

**File:** `app/api/bookings/create/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/auth';
import { supabase } from '@/lib/supabase';

export async function POST(req: NextRequest) {
  try {
    const session = await auth();
    const body = await req.json();

    const {
      serviceType,
      scheduledDate,
      scheduledTime,
      address,
      guestEmail,
      guestPhone,
      guestName,
      specialRequests,
    } = body;

    let userId = session?.user?.id;

    // If not logged in, check if user exists by email
    if (!userId && guestEmail) {
      const { data: existingUser } = await supabase
        .from('users')
        .select('id')
        .eq('email', guestEmail)
        .single();

      if (existingUser) {
        userId = existingUser.id;
      } else {
        // Create new user
        const { data: newUser } = await supabase
          .from('users')
          .insert({
            email: guestEmail,
            phone: guestPhone,
            name: guestName,
            email_verified: false,
            first_booking_at: new Date().toISOString(),
          })
          .select()
          .single();

        userId = newUser.id;
      }
    }

    // Create address
    const { data: addressRecord } = await supabase
      .from('addresses')
      .insert({
        user_id: userId,
        ...address,
      })
      .select()
      .single();

    // Create booking
    const { data: booking } = await supabase
      .from('bookings')
      .insert({
        user_id: userId,
        service_type: serviceType,
        scheduled_date: scheduledDate,
        scheduled_time: scheduledTime,
        address_id: addressRecord.id,
        special_requests: specialRequests,
        status: 'pending',
        guest_email: !userId ? guestEmail : null,
        guest_phone: !userId ? guestPhone : null,
        guest_name: !userId ? guestName : null,
      })
      .select()
      .single();

    // Send confirmation email with magic link
    await sendBookingConfirmationEmail({
      email: guestEmail,
      booking,
      magicLinkUrl: `/api/auth/magic-link?email=${guestEmail}&bookingId=${booking.id}`,
    });

    return NextResponse.json({ booking });
  } catch (error) {
    console.error('Error creating booking:', error);
    return NextResponse.json(
      { error: 'Failed to create booking' },
      { status: 500 }
    );
  }
}
```

3. **Create magic link handler for auto-login:**

**File:** `app/api/auth/magic-link/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { signIn } from '@/auth';

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const email = searchParams.get('email');
  const bookingId = searchParams.get('bookingId');

  if (!email) {
    return NextResponse.redirect('/login?error=InvalidMagicLink');
  }

  // Auto sign-in
  await signIn('email', {
    email,
    redirect: false,
  });

  // Redirect to booking details
  const redirectUrl = bookingId
    ? `/dashboard/bookings/${bookingId}`
    : '/dashboard';

  return NextResponse.redirect(redirectUrl);
}
```

4. **Booking confirmation email template:**

**File:** `lib/email-templates/booking-confirmation.ts`
```typescript
export function bookingConfirmationEmail({
  name,
  serviceType,
  date,
  time,
  address,
  price,
  magicLinkUrl,
}: {
  name: string;
  serviceType: string;
  date: string;
  time: string;
  address: string;
  price: number;
  magicLinkUrl: string;
}) {
  return `
    <!DOCTYPE html>
    <html>
      <body style="font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 24px;">
        <h1 style="font-size: 24px; font-weight: 600; margin-bottom: 24px;">
          Your cleaning is confirmed
        </h1>
        
        <p style="font-size: 16px; color: #525252; margin-bottom: 24px;">
          Hi ${name}, your ${serviceType} is scheduled for:
        </p>
        
        <div style="background: #F5F5F5; padding: 24px; border-radius: 2px; margin-bottom: 24px;">
          <p style="margin: 0 0 8px 0;"><strong>Date:</strong> ${date}</p>
          <p style="margin: 0 0 8px 0;"><strong>Time:</strong> ${time}</p>
          <p style="margin: 0 0 8px 0;"><strong>Address:</strong> ${address}</p>
          <p style="margin: 0;"><strong>Price:</strong> $${price}</p>
        </div>
        
        <a 
          href="${magicLinkUrl}" 
          style="
            display: inline-block;
            background: #D97757;
            color: white;
            padding: 12px 32px;
            text-decoration: none;
            border-radius: 2px;
            font-weight: 500;
            margin-bottom: 24px;
          "
        >
          View Booking Details
        </a>
        
        <p style="font-size: 14px; color: #737373;">
          Click the button above to view your booking and manage it anytime.
        </p>
      </body>
    </html>
  `;
}
```

**Acceptance Criteria:**
- [ ] Guest может забукать без аккаунта
- [ ] User автоматически создаётся при первом букинге
- [ ] Email с magic link отправляется
- [ ] Magic link логинит и ведёт на booking details
- [ ] Если user уже существует (по email), booking привязывается к нему

---

---

# PART 2: DASHBOARD

## TASK 7: Dashboard Layout & Navigation

**Цель:** Создать базовую структуру dashboard с навигацией.

**Что сделать:**

1. **Create dashboard layout:**

**File:** `app/dashboard/layout.tsx`
```typescript
import { auth } from '@/auth';
import { redirect } from 'next/navigation';
import { DashboardNav } from '@/components/dashboard/nav';
import { DashboardHeader } from '@/components/dashboard/header';

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth();

  if (!session) {
    redirect('/login');
  }

  return (
    <div className="min-h-screen bg-background">
      <DashboardHeader user={session.user} />
      
      <div className="max-w-7xl mx-auto px-6 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          {/* Sidebar Navigation */}
          <aside className="lg:col-span-3">
            <DashboardNav />
          </aside>

          {/* Main Content */}
          <main className="lg:col-span-9">
            {children}
          </main>
        </div>
      </div>
    </div>
  );
}
```

2. **Create dashboard header:**

**File:** `components/dashboard/header.tsx`
```typescript
'use client';

import Link from 'next/link';
import { signOut } from 'next-auth/react';
import { Button } from '@/components/ui/button';
import { User } from 'next-auth';

export function DashboardHeader({ user }: { user: User }) {
  return (
    <header className="border-b border-gray-200 bg-white">
      <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <Link href="/" className="text-xl font-semibold text-foreground">
          CLEENLY
        </Link>

        <div className="flex items-center gap-4">
          <span className="text-sm text-gray-600">
            {user.name || user.email}
          </span>
          
          <Button
            variant="link"
            size="sm"
            onClick={() => signOut({ callbackUrl: '/' })}
          >
            Sign Out
          </Button>
        </div>
      </div>
    </header>
  );
}
```

3. **Create dashboard navigation:**

**File:** `components/dashboard/nav.tsx`
```typescript
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import { 
  Calendar, 
  MapPin, 
  CreditCard, 
  Settings, 
  Gift 
} from 'lucide-react';

const navItems = [
  {
    label: 'My Bookings',
    href: '/dashboard/bookings',
    icon: Calendar,
  },
  {
    label: 'My Addresses',
    href: '/dashboard/addresses',
    icon: MapPin,
  },
  {
    label: 'Payment Methods',
    href: '/dashboard/payments',
    icon: CreditCard,
  },
  {
    label: 'Referrals',
    href: '/dashboard/referrals',
    icon: Gift,
  },
  {
    label: 'Settings',
    href: '/dashboard/settings',
    icon: Settings,
  },
];

export function DashboardNav() {
  const pathname = usePathname();

  return (
    <nav className="space-y-1">
      {navItems.map((item) => {
        const isActive = pathname.startsWith(item.href);
        const Icon = item.icon;

        return (
          <Link
            key={item.href}
            href={item.href}
            className={cn(
              'flex items-center gap-3 px-4 py-3 rounded-sm text-sm font-medium transition-colors',
              isActive
                ? 'bg-accent/10 text-accent'
                : 'text-gray-600 hover:bg-gray-50 hover:text-foreground'
            )}
          >
            <Icon className="w-5 h-5" />
            {item.label}
          </Link>
        );
      })}
    </nav>
  );
}
```

4. **Create dashboard home/overview:**

**File:** `app/dashboard/page.tsx`
```typescript
import { auth } from '@/auth';
import { supabase } from '@/lib/supabase';
import { redirect } from 'next/navigation';
import { UpcomingBookings } from '@/components/dashboard/upcoming-bookings';
import { QuickActions } from '@/components/dashboard/quick-actions';

export default async function DashboardPage() {
  const session = await auth();
  if (!session) redirect('/login');

  // Fetch upcoming bookings
  const { data: upcomingBookings } = await supabase
    .from('bookings')
    .select('*, addresses(*), cleaners(*)')
    .eq('user_id', session.user.id)
    .gte('scheduled_date', new Date().toISOString().split('T')[0])
    .order('scheduled_date', { ascending: true })
    .limit(3);

  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-3xl font-semibold">
          Welcome back, {session.user.name?.split(' ')[0] || 'there'}
        </h1>
        <p className="text-gray-600 mt-2">
          Manage your cleanings and account
        </p>
      </div>

      <QuickActions />

      {upcomingBookings && upcomingBookings.length > 0 && (
        <UpcomingBookings bookings={upcomingBookings} />
      )}
    </div>
  );
}
```

5. **Quick actions component:**

**File:** `components/dashboard/quick-actions.tsx`
```typescript
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Plus, Calendar, Gift } from 'lucide-react';

export function QuickActions() {
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      <Link
        href="/book"
        className="border border-gray-200 p-6 rounded-sm hover:shadow-card transition-shadow"
      >
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 bg-accent/10 rounded-sm flex items-center justify-center">
            <Plus className="w-6 h-6 text-accent" />
          </div>
          <div>
            <h3 className="font-semibold">Book Cleaning</h3>
            <p className="text-sm text-gray-600">Schedule a new service</p>
          </div>
        </div>
      </Link>

      <Link
        href="/dashboard/bookings"
        className="border border-gray-200 p-6 rounded-sm hover:shadow-card transition-shadow"
      >
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 bg-gray-100 rounded-sm flex items-center justify-center">
            <Calendar className="w-6 h-6 text-gray-600" />
          </div>
          <div>
            <h3 className="font-semibold">View Bookings</h3>
            <p className="text-sm text-gray-600">See upcoming cleanings</p>
          </div>
        </div>
      </Link>

      <Link
        href="/dashboard/referrals"
        className="border border-gray-200 p-6 rounded-sm hover:shadow-card transition-shadow"
      >
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 bg-gray-100 rounded-sm flex items-center justify-center">
            <Gift className="w-6 h-6 text-gray-600" />
          </div>
          <div>
            <h3 className="font-semibold">Refer & Earn</h3>
            <p className="text-sm text-gray-600">Get $25 credit</p>
          </div>
        </div>
      </Link>
    </div>
  );
}
```

**Acceptance Criteria:**
- [ ] Dashboard layout рендерится
- [ ] Navigation работает (active state)
- [ ] Header показывает user info
- [ ] Sign out работает
- [ ] Mobile: навигация адаптируется (hamburger или stack)
- [ ] Quick actions кликабельны

---

## TASK 8: My Bookings (List + Filters)

**Цель:** Страница со списком всех букингов с фильтрами.

**Что сделать:**

1. **Create bookings page:**

**File:** `app/dashboard/bookings/page.tsx`
```typescript
import { auth } from '@/auth';
import { supabase } from '@/lib/supabase';
import { redirect } from 'next/navigation';
import { BookingsList } from '@/components/dashboard/bookings-list';
import { BookingFilters } from '@/components/dashboard/booking-filters';

export default async function BookingsPage({
  searchParams,
}: {
  searchParams: { status?: string };
}) {
  const session = await auth();
  if (!session) redirect('/login');

  const status = searchParams.status || 'upcoming';

  // Build query based on status
  let query = supabase
    .from('bookings')
    .select('*, addresses(*), cleaners(*)')
    .eq('user_id', session.user.id);

  const today = new Date().toISOString().split('T')[0];

  if (status === 'upcoming') {
    query = query
      .gte('scheduled_date', today)
      .in('status', ['pending', 'confirmed'])
      .order('scheduled_date', { ascending: true });
  } else if (status === 'past') {
    query = query
      .lt('scheduled_date', today)
      .eq('status', 'completed')
      .order('scheduled_date', { ascending: false });
  } else if (status === 'cancelled') {
    query = query
      .eq('status', 'cancelled')
      .order('created_at', { ascending: false });
  }

  const { data: bookings } = await query;

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-semibold">My Bookings</h1>
        <p className="text-gray-600 mt-2">
          View and manage your cleaning appointments
        </p>
      </div>

      <BookingFilters currentStatus={status} />

      <BookingsList bookings={bookings || []} />
    </div>
  );
}
```

2. **Create booking filters (tabs):**

**File:** `components/dashboard/booking-filters.tsx`
```typescript
'use client';

import Link from 'next/link';
import { cn } from '@/lib/utils';

const filters = [
  { label: 'Upcoming', value: 'upcoming' },
  { label: 'Past', value: 'past' },
  { label: 'Cancelled', value: 'cancelled' },
];

export function BookingFilters({ currentStatus }: { currentStatus: string }) {
  return (
    <div className="border-b border-gray-200">
      <div className="flex gap-6">
        {filters.map((filter) => (
          <Link
            key={filter.value}
            href={`/dashboard/bookings?status=${filter.value}`}
            className={cn(
              'pb-3 border-b-2 transition-colors',
              currentStatus === filter.value
                ? 'border-accent text-accent font-medium'
                : 'border-transparent text-gray-600 hover:text-foreground'
            )}
          >
            {filter.label}
          </Link>
        ))}
      </div>
    </div>
  );
}
```

3. **Create bookings list:**

**File:** `components/dashboard/bookings-list.tsx`
```typescript
import Link from 'next/link';
import { format } from 'date-fns';
import { Calendar, MapPin, DollarSign } from 'lucide-react';
import { Button } from '@/components/ui/button';

type Booking = {
  id: string;
  service_type: string;
  scheduled_date: string;
  scheduled_time: string;
  status: string;
  price_final: number;
  addresses: {
    street_address: string;
    city: string;
  };
  cleaners?: {
    name: string;
    profile_photo?: string;
  };
};

export function BookingsList({ bookings }: { bookings: Booking[] }) {
  if (bookings.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-gray-600 mb-4">No bookings found</p>
        <Link href="/book">
          <Button variant="primary">Book Your First Cleaning</Button>
        </Link>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {bookings.map((booking) => (
        <BookingCard key={booking.id} booking={booking} />
      ))}
    </div>
  );
}

function BookingCard({ booking }: { booking: Booking }) {
  const serviceTypeLabel = {
    regular: 'Regular Cleaning',
    deep: 'Deep Cleaning',
    move_out: 'Move-Out Cleaning',
  }[booking.service_type];

  return (
    <Link
      href={`/dashboard/bookings/${booking.id}`}
      className="block border border-gray-200 p-6 rounded-sm hover:shadow-card transition-shadow"
    >
      <div className="flex items-start justify-between mb-4">
        <div>
          <h3 className="font-semibold text-lg">{serviceTypeLabel}</h3>
          <div className="flex items-center gap-4 mt-2 text-sm text-gray-600">
            <span className="flex items-center gap-1">
              <Calendar className="w-4 h-4" />
              {format(new Date(booking.scheduled_date), 'MMM d, yyyy')} • {booking.scheduled_time}
            </span>
          </div>
        </div>

        <StatusBadge status={booking.status} />
      </div>

      {booking.cleaners && (
        <div className="flex items-center gap-3 mb-4">
          {booking.cleaners.profile_photo ? (
            <img
              src={booking.cleaners.profile_photo}
              alt={booking.cleaners.name}
              className="w-10 h-10 rounded-full object-cover"
            />
          ) : (
            <div className="w-10 h-10 rounded-full bg-gray-200" />
          )}
          <div>
            <p className="text-sm font-medium">{booking.cleaners.name}</p>
          </div>
        </div>
      )}

      <div className="flex items-center justify-between pt-4 border-t border-gray-200">
        <div className="text-sm text-gray-600 flex items-center gap-1">
          <MapPin className="w-4 h-4" />
          {booking.addresses.street_address}, {booking.addresses.city}
        </div>

        <div className="flex items-center gap-1 font-semibold">
          <DollarSign className="w-4 h-4" />
          {(booking.price_final / 100).toFixed(0)}
        </div>
      </div>
    </Link>
  );
}

function StatusBadge({ status }: { status: string }) {
  const styles = {
    pending: 'bg-yellow-100 text-yellow-700',
    confirmed: 'bg-green-100 text-green-700',
    in_progress: 'bg-blue-100 text-blue-700',
    completed: 'bg-gray-100 text-gray-700',
    cancelled: 'bg-red-100 text-red-700',
  }[status] || 'bg-gray-100 text-gray-700';

  const label = status.replace('_', ' ');

  return (
    <span className={`px-3 py-1 rounded-sm text-xs font-medium capitalize ${styles}`}>
      {label}
    </span>
  );
}
```

**Acceptance Criteria:**
- [ ] Bookings отображаются в списке
- [ ] Фильтры (tabs) работают
- [ ] Status badges правильные цвета
- [ ] Клик на booking ведёт на детальную страницу
- [ ] Empty state показывается когда нет букингов
- [ ] Date formatting правильный

---

## TASK 9: Booking Details Page

**Цель:** Детальная страница букинга с действиями (reschedule, cancel, contact).

**Что сделать:**

1. **Create booking details page:**

**File:** `app/dashboard/bookings/[id]/page.tsx`
```typescript
import { auth } from '@/auth';
import { supabase } from '@/lib/supabase';
import { redirect, notFound } from 'next/navigation';
import { format } from 'date-fns';
import { BookingActions } from '@/components/dashboard/booking-actions';
import { BookingTimeline } from '@/components/dashboard/booking-timeline';
import { CleanerInfo } from '@/components/dashboard/cleaner-info';
import { PaymentInfo } from '@/components/dashboard/payment-info';

export default async function BookingDetailsPage({
  params,
}: {
  params: { id: string };
}) {
  const session = await auth();
  if (!session) redirect('/login');

  const { data: booking } = await supabase
    .from('bookings')
    .select('*, addresses(*), cleaners(*), payments(*)')
    .eq('id', params.id)
    .eq('user_id', session.user.id)
    .single();

  if (!booking) notFound();

  const serviceTypeLabel = {
    regular: 'Regular Cleaning',
    deep: 'Deep Cleaning',
    move_out: 'Move-Out Cleaning',
  }[booking.service_type];

  return (
    <div className="space-y-8">
      {/* Header */}
      <div>
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-3xl font-semibold">{serviceTypeLabel}</h1>
            <p className="text-gray-600 mt-2">
              Booking #{booking.id.slice(0, 8)}
            </p>
          </div>
          <StatusBadge status={booking.status} />
        </div>
      </div>

      {/* Details Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Main Column */}
        <div className="lg:col-span-2 space-y-6">
          {/* Date & Time */}
          <section className="border border-gray-200 p-6 rounded-sm">
            <h2 className="font-semibold mb-4">Schedule</h2>
            <div className="space-y-2">
              <p className="text-sm">
                <span className="text-gray-600">Date:</span>{' '}
                <span className="font-medium">
                  {format(new Date(booking.scheduled_date), 'EEEE, MMMM d, yyyy')}
                </span>
              </p>
              <p className="text-sm">
                <span className="text-gray-600">Time:</span>{' '}
                <span className="font-medium">{booking.scheduled_time}</span>
              </p>
              <p className="text-sm">
                <span className="text-gray-600">Duration:</span>{' '}
                <span className="font-medium">~{booking.estimated_duration} minutes</span>
              </p>
            </div>
          </section>

          {/* Address */}
          <section className="border border-gray-200 p-6 rounded-sm">
            <h2 className="font-semibold mb-4">Location</h2>
            <div className="space-y-1">
              <p className="font-medium">{booking.addresses.street_address}</p>
              {booking.addresses.unit && (
                <p className="text-sm text-gray-600">Unit {booking.addresses.unit}</p>
              )}
              <p className="text-sm text-gray-600">
                {booking.addresses.city}, {booking.addresses.state} {booking.addresses.zip_code}
              </p>
            </div>
            {booking.addresses.special_instructions && (
              <div className="mt-4 pt-4 border-t">
                <p className="text-xs text-gray-600 mb-1">Special Instructions:</p>
                <p className="text-sm">{booking.addresses.special_instructions}</p>
              </div>
            )}
          </section>

          {/* Cleaner Info */}
          {booking.cleaners && (
            <CleanerInfo cleaner={booking.cleaners} bookingId={booking.id} />
          )}

          {/* Timeline */}
          <BookingTimeline booking={booking} />
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          {/* Payment Info */}
          <PaymentInfo payment={booking.payments?.[0]} booking={booking} />

          {/* Actions */}
          <BookingActions booking={booking} />
        </div>
      </div>
    </div>
  );
}
```

2. **Cleaner info component:**

**File:** `components/dashboard/cleaner-info.tsx`
```typescript
import { Star, MessageCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';

export function CleanerInfo({ 
  cleaner, 
  bookingId 
}: { 
  cleaner: any; 
  bookingId: string;
}) {
  return (
    <section className="border border-gray-200 p-6 rounded-sm">
      <h2 className="font-semibold mb-4">Your Cleaner</h2>
      
      <div className="flex items-start gap-4">
        {cleaner.profile_photo ? (
          <img
            src={cleaner.profile_photo}
            alt={cleaner.name}
            className="w-16 h-16 rounded-full object-cover"
          />
        ) : (
          <div className="w-16 h-16 rounded-full bg-gray-200" />
        )}

        <div className="flex-1">
          <h3 className="font-semibold">{cleaner.name}</h3>
          
          <div className="flex items-center gap-2 mt-1">
            <div className="flex items-center gap-1 text-sm">
              <Star className="w-4 h-4 fill-current text-accent" />
              <span className="font-medium">{cleaner.rating}</span>
            </div>
            <span className="text-sm text-gray-600">
              ({cleaner.total_reviews} reviews)
            </span>
          </div>

          <p className="text-sm text-gray-600 mt-2">
            {cleaner.total_bookings} cleanings completed
          </p>
        </div>
      </div>

      <Button
        variant="secondary"
        size="sm"
        className="w-full mt-4"
        onClick={() => {
          // Open chat or contact modal
        }}
      >
        <MessageCircle className="w-4 h-4 mr-2" />
        Contact Cleaner
      </Button>
    </section>
  );
}
```

3. **Payment info component:**

**File:** `components/dashboard/payment-info.tsx`
```typescript
import { format } from 'date-fns';
import { CreditCard, Banknote, FileText } from 'lucide-react';
import { Button } from '@/components/ui/button';

export function PaymentInfo({ 
  payment, 
  booking 
}: { 
  payment: any; 
  booking: any;
}) {
  const paymentMethodIcons = {
    card: CreditCard,
    cash: Banknote,
    check: FileText,
  };

  const Icon = payment?.payment_method 
    ? paymentMethodIcons[payment.payment_method as keyof typeof paymentMethodIcons]
    : CreditCard;

  return (
    <section className="border border-gray-200 p-6 rounded-sm">
      <h2 className="font-semibold mb-4">Payment</h2>

      <div className="space-y-3">
        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">Method</span>
          <div className="flex items-center gap-2">
            <Icon className="w-4 h-4 text-gray-600" />
            <span className="font-medium capitalize">
              {payment?.payment_method || 'Pending'}
            </span>
          </div>
        </div>

        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">Amount</span>
          <span className="font-medium">
            ${((booking.price_final || booking.price_quoted) / 100).toFixed(2)}
          </span>
        </div>

        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">Status</span>
          <PaymentStatusBadge status={payment?.status || 'pending'} />
        </div>
      </div>

      {payment?.status === 'completed' && (
        <Button
          variant="link"
          size="sm"
          className="w-full mt-4"
          onClick={() => {
            // Download receipt
          }}
        >
          Download Receipt
        </Button>
      )}

      {payment?.status === 'pending' && booking.status === 'confirmed' && (
        <div className="mt-4 p-3 bg-yellow-50 rounded-sm">
          <p className="text-xs text-yellow-800">
            Payment will be processed 24 hours before your scheduled cleaning.
          </p>
        </div>
      )}
    </section>
  );
}

function PaymentStatusBadge({ status }: { status: string }) {
  const styles = {
    pending: 'bg-yellow-100 text-yellow-700',
    authorized: 'bg-blue-100 text-blue-700',
    captured: 'bg-green-100 text-green-700',
    completed: 'bg-gray-100 text-gray-700',
    failed: 'bg-red-100 text-red-700',
  }[status] || 'bg-gray-100 text-gray-700';

  return (
    <span className={`px-2 py-1 rounded-sm text-xs font-medium capitalize ${styles}`}>
      {status}
    </span>
  );
}
```

4. **Booking actions component:**

**File:** `components/dashboard/booking-actions.tsx`
```typescript
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Calendar, X } from 'lucide-react';

export function BookingActions({ booking }: { booking: any }) {
  const [loading, setLoading] = useState(false);

  const canReschedule = ['pending', 'confirmed'].includes(booking.status);
  const canCancel = ['pending', 'confirmed'].includes(booking.status);

  const handleReschedule = async () => {
    // Open reschedule modal
  };

  const handleCancel = async () => {
    if (!confirm('Are you sure you want to cancel this booking?')) return;

    setLoading(true);
    try {
      const res = await fetch(`/api/bookings/${booking.id}/cancel`, {
        method: 'POST',
      });

      if (res.ok) {
        window.location.reload();
      }
    } catch (error) {
      console.error('Error cancelling booking:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <section className="border border-gray-200 p-6 rounded-sm space-y-3">
      <h2 className="font-semibold mb-4">Actions</h2>

      {canReschedule && (
        <Button
          variant="secondary"
          className="w-full"
          onClick={handleReschedule}
        >
          <Calendar className="w-4 h-4 mr-2" />
          Reschedule
        </Button>
      )}

      {canCancel && (
        <Button
          variant="secondary"
          className="w-full text-red-600 hover:text-red-700"
          onClick={handleCancel}
          disabled={loading}
        >
          <X className="w-4 h-4 mr-2" />
          {loading ? 'Cancelling...' : 'Cancel Booking'}
        </Button>
      )}

      {booking.status === 'completed' && !booking.review && (
        <Button
          variant="primary"
          className="w-full"
          onClick={() => {
            // Open review modal
          }}
        >
          Leave a Review
        </Button>
      )}

      <Button
        variant="secondary"
        className="w-full"
        onClick={() => {
          // Rebook with same settings
        }}
      >
        Book Again
      </Button>
    </section>
  );
}
```

5. **Booking timeline component:**

**File:** `components/dashboard/booking-timeline.tsx`
```typescript
import { format } from 'date-fns';
import { Check, Clock, X } from 'lucide-react';

export function BookingTimeline({ booking }: { booking: any }) {
  const events = [
    {
      status: 'created',
      label: 'Booking Created',
      timestamp: booking.created_at,
      completed: true,
    },
    {
      status: 'confirmed',
      label: 'Confirmed',
      timestamp: booking.confirmed_at,
      completed: ['confirmed', 'in_progress', 'completed'].includes(booking.status),
    },
    {
      status: 'in_progress',
      label: 'Cleaning Started',
      timestamp: booking.started_at,
      completed: ['in_progress', 'completed'].includes(booking.status),
    },
    {
      status: 'completed',
      label: 'Completed',
      timestamp: booking.completed_at,
      completed: booking.status === 'completed',
    },
  ];

  if (booking.status === 'cancelled') {
    events.push({
      status: 'cancelled',
      label: 'Cancelled',
      timestamp: booking.cancelled_at,
      completed: true,
    });
  }

  return (
    <section className="border border-gray-200 p-6 rounded-sm">
      <h2 className="font-semibold mb-4">Timeline</h2>

      <div className="space-y-4">
        {events.map((event, index) => (
          <div key={event.status} className="flex gap-4">
            <div className="flex flex-col items-center">
              <div
                className={`w-8 h-8 rounded-full flex items-center justify-center ${
                  event.completed
                    ? event.status === 'cancelled'
                      ? 'bg-red-100'
                      : 'bg-green-100'
                    : 'bg-gray-100'
                }`}
              >
                {event.completed ? (
                  event.status === 'cancelled' ? (
                    <X className="w-4 h-4 text-red-600" />
                  ) : (
                    <Check className="w-4 h-4 text-green-600" />
                  )
                ) : (
                  <Clock className="w-4 h-4 text-gray-400" />
                )}
              </div>
              {index < events.length - 1 && (
                <div
                  className={`w-0.5 h-12 ${
                    event.completed ? 'bg-gray-300' : 'bg-gray-200'
                  }`}
                />
              )}
            </div>

            <div className="flex-1 pb-6">
              <p className="font-medium">{event.label}</p>
              {event.timestamp && (
                <p className="text-sm text-gray-600">
                  {format(new Date(event.timestamp), 'MMM d, yyyy h:mm a')}
                </p>
              )}
            </div>
          </div>
        ))}
      </div>
    </section>
  );
}
```

**Acceptance Criteria:**
- [ ] Booking details отображаются полностью
- [ ] Cleaner info показывается если assigned
- [ ] Payment info правильная
- [ ] Timeline показывает progress
- [ ] Actions (reschedule, cancel) работают
- [ ] Review button показывается после completion
- [ ] Mobile responsive

---

Женя, продолжаю с остальными заданиями Dashboard (Addresses, Payments, Settings, Referrals)?